<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
<link rel="icon">
<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="https://img.highcharts.com.cn/libs/font-awesome/css/font-awesome.min.css"/>
	<script src="https://img.highcharts.com.cn/jquery/jquery-1.8.3.min.js"></script>
	<script src="https://img.highcharts.com.cn/highcharts/highcharts.js"></script>
	<!-- <script src="https://img.highcharts.com.cn/highcharts/modules/exporting.js"></script> -->
	<script src="https://img.hcharts.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
</head>
<body>

	<div id="container" style="width: 800px; height: 310px; margin: 0 auto">
	<div style="margin-top: 100px; text-align: center" id="loading">
		<i class="fa fa-spinner fa-spin"></i> 从外部源加载数据
	</div>
</div>
	<script>
	
function Meteogram(xml, container) {
    this.symbols = [];
    this.symbolNames = [];
    this.precipitations = [];
    this.windDirections = [];
    this.windDirectionNames = [];
    this.windDirections =[];
    this.windSpeeds = [];
    this.windSpeedNames = [];
    this.temperatures = [];
    this.pressures = [];
    this.xml = xml;
    this.container = container;
    this.parseYrData();
}
//获取天气符号方法
// Meteogram.prototype.getSymbolSprites = function (symbolSize) {
//     return {
//         '01d': {
//             x: 0,
//             y: 0
//         },
//         '01n': {
//             x: symbolSize,
//             y: 0
//         },
//         '16': {
//             x: 2 * symbolSize,
//             y: 0
//         },
//         '02d': {
//             x: 0,
//             y: symbolSize
//         },
//         '02n': {
//             x: symbolSize,
//             y: symbolSize
//         },
//         '03d': {
//             x: 0,
//             y: 2 * symbolSize
//         },
//         '03n': {
//             x: symbolSize,
//             y: 2 * symbolSize
//         },
//         '17': {
//             x: 2 * symbolSize,
//             y: 2 * symbolSize
//         },
//         '04': {
//             x: 0,
//             y: 3 * symbolSize
//         },
//         '05d': {
//             x: 0,
//             y: 4 * symbolSize
//         },
//         '05n': {
//             x: symbolSize,
//             y: 4 * symbolSize
//         },
//         '18': {
//             x: 2 * symbolSize,
//             y: 4 * symbolSize
//         },
//         '06d': {
//             x: 0,
//             y: 5 * symbolSize
//         },
//         '06n': {
//             x: symbolSize,
//             y: 5 * symbolSize
//         },
//         '07d': {
//             x: 0,
//             y: 6 * symbolSize
//         },
//         '07n': {
//             x: symbolSize,
//             y: 6 * symbolSize
//         },
//         '08d': {
//             x: 0,
//             y: 7 * symbolSize
//         },
//         '08n': {
//             x: symbolSize,
//             y: 7 * symbolSize
//         },
//         '19': {
//             x: 2 * symbolSize,
//             y: 7 * symbolSize
//         },
//         '09': {
//             x: 0,
//             y: 8 * symbolSize
//         },
//         '10': {
//             x: 0,
//             y: 9 * symbolSize
//         },
//         '11': {
//             x: 0,
//             y: 10 * symbolSize
//         },
//         '12': {
//             x: 0,
//             y: 11 * symbolSize
//         },
//         '13': {
//             x: 0,
//             y: 12 * symbolSize
//         },
//         '14': {
//             x: 0,
//             y: 13 * symbolSize
//         },
//         '15': {
//             x: 0,
//             y: 14 * symbolSize
//         },
//         '20d': {
//             x: 0,
//             y: 15 * symbolSize
//         },
//         '20n': {
//             x: symbolSize,
//             y: 15 * symbolSize
//         },
//         '20m': {
//             x: 2 * symbolSize,
//             y: 15 * symbolSize
//         },
//         '21d': {
//             x: 0,
//             y: 16 * symbolSize
//         },
//         '21n': {
//             x: symbolSize,
//             y: 16 * symbolSize
//         },
//         '21m': {
//             x: 2 * symbolSize,
//             y: 16 * symbolSize
//         },
//         '22': {
//             x: 0,
//             y: 17 * symbolSize
//         },
//         '23': {
//             x: 0,
//             y: 18 * symbolSize
//         }
//     };
// };
/**
 *绘制气温曲线
 */
// Meteogram.prototype.smoothLine = function (data) {
//     console.log(data);
//     var i = data.length,
//         sum,
//         value;
//     while (i--) {
//         data[i].value = value = data[i].y; 
//         sum = (data[i - 1] || data[i]).y + value + (data[i + 1] || data[i]).y;
//         data[i].y = Math.max(value - 0.5, Math.min(sum / 3, value + 0.5));
//     }
// };
/**
 * 鼠标悬停时的回调函数toolip提示工具
 */
Meteogram.prototype.tooltipFormatter = function (tooltip) {
    // 参照时间间隔创建标题
    var index = tooltip.points[0].point.index,
        ret = '<small>' + Highcharts.dateFormat('%A, %b %e, %H:%M', tooltip.x) + '-' +
        Highcharts.dateFormat('%H:%M', tooltip.points[0].point.to) + '</small><br>';
    // 文字标识
    // ret += '<b>' + this.symbolNames[index] + '</b>';
    ret += '<table>';
    // tooltip悬停显示
    // Highcharts.each(tooltip.points, function (point) {
    //     var series = point.series;
    //     ret += '<tr><td><span style="color:' + series.color + '">\u25CF</span> ' + series.name +
    //         ': </td><td style="white-space:nowrap">' + Highcharts.pick(point.point.value, point.y) +
    //         series.options.tooltip.valueSuffix + '</td></tr>';
    // });
    // 风
    ret += '<tr><td style="vertical-align: top">\u25CF 风向/风速：</td><td style="white-space:nowrap">' + this.windDirections[index] + '°'+
        // '<br>' + this.windSpeedNames[index] + ' (' +
       '/' + Highcharts.numberFormat(this.windSpeeds[index].y, 1) + ' m/s)</td></tr>';
    // Close
    ret += '</table>';  
    return ret;
};
/**
 * 在温度曲线上绘制天气符号
 */
// Meteogram.prototype.drawWeatherSymbols = function (chart) {
//     var meteogram = this,
//         symbolSprites = this.getSymbolSprites(30);
//     $.each(chart.series[0].data, function (i, point) {
//         var sprite,
//             group;
//         if (meteogram.resolution > 36e5 || i % 2 === 0) {
//             sprite = symbolSprites[meteogram.symbols[i]];
//             if (sprite) {
//                 // Create a group element that is positioned and clipped at 30 pixels width and height
//                 group = chart.renderer.g()
//                     .attr({
//                     translateX: point.plotX + chart.plotLeft - 15,
//                     translateY: point.plotY + chart.plotTop - 30,
//                     zIndex: 5
//                 })
//                     .clip(chart.renderer.clipRect(0, 0, 30, 30))
//                     .add();
//                 // Position the image inside it at the sprite position
//                 chart.renderer.image(
//                     'https://www.highcharts.com/samples/graphics/meteogram-symbols-30px.png',
//                     -sprite.x,
//                     -sprite.y,
//                     90,
//                     570
//                 )
//                     .add(group);
//             }
//         }
//     });
// };
/**
 * 创建SVG可旋转的风速标识
   0 无风  1软风  2轻风  3微风  4和风 5劲风  6强风  7疾风 8大风 9烈风 10狂风 11暴风 12飓风
 */
Meteogram.prototype.windArrow = function (name) {
    var level,//风速等级
        path;//绘制路径
    path = [
        'M', 0, 7, // base of arrow
        'L', -1.5, 7,
        0, 10,
        1.5, 7,
        0, 7,
        0, -10, // top
    ];
    //根据windSpeedNames在数组里面的索引绘制风速拐角（英文作为模拟数据）
    //模拟数据
    level = $.inArray(name, ['平静', 'Fresh breeze', 'Light breeze', 'Light air', 'Gentle breeze',
                             '清劲风', '大风', 'Moderate breeze', '狂风', '裂风', '暴风',
                             '大风暴', '飓风']);
    //正式环境 0 无风  1软风  2轻风  3微风  4和风 5劲风  6强风  7疾风 8大风 9烈风 10狂风 11暴风 12飓风
    // level = $.inArray(name, [0,1,2,3,4,5,6,7,8,9,10,11,12]);                         
    if (level === 0) {
        path = [];
    }
    if (level === 2) {
        path.push('M', 0, -8, 'L', 4, -8); // 短线
    } else if (level >= 3) {
        path.push(0, -10, 7, -10); // 长线
    }
    if (level === 4) {
        path.push('M', 0, -7, 'L', 4, -7);
    } else if (level >= 5) {
        path.push('M', 0, -7, 'L', 7, -7);
    }
    if (level === 5) {
        path.push('M', 0, -4, 'L', 4, -4);
    } else if (level >= 6) {
        path.push('M', 0, -4, 'L', 7, -4);
    }
    if (level === 7) {
        path.push('M', 0, -1, 'L', 4, -1);
    } else if (level >= 8) {
        path.push('M', 0, -1, 'L', 7, -1);
    }
    return path;
};
/**
 * 绘制风向箭头，路径由上面的windArrow返回path
 */
Meteogram.prototype.drawWindArrows = function (chart) {
    var meteogram = this;
    $.each(chart.series[0].data, function (i, point) {
        var sprite, arrow, x, y;
        if (meteogram.resolution > 36e5 || i % 2 === 0) {
            // 绘制风向箭头
            x = point.plotX + chart.plotLeft + 7;
            y = 255;
            if (meteogram.windSpeedNames[i] === 'Calm') {
                arrow = chart.renderer.circle(x, y, 10).attr({
                    fill: 'none'
                });
            } else {
                arrow = chart.renderer.path(
                    meteogram.windArrow(meteogram.windSpeedNames[i])
                ).attr({
                    rotation: parseInt(meteogram.windDirections[i], 10),
                    translateX: x, // rotation center
                    translateY: y // rotation center
                });
            }
            arrow.attr({
                stroke: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                'stroke-width': 1.5,
                zIndex: 5
            })
                .add();
        }
    });
};
/**
 * 绘制风向标识的边框
 */
// Meteogram.prototype.drawBlocksForWindArrows = function (chart) {
//     var xAxis = chart.xAxis[0],
//         x,
//         pos,
//         max,
//         isLong,
//         isLast,
//         i;
//     for (pos = xAxis.min, max = xAxis.max, i = 0; pos <= max + 36e5; pos += 36e5, i += 1) {
//         // Get the X position
//         isLast = pos === max + 36e5;
//         x = Math.round(xAxis.toPixels(pos)) + (isLast ? 0.5 : -0.5);
//         // Draw the vertical dividers and ticks
//         if (this.resolution > 36e5) {
//             isLong = pos % this.resolution === 0;
//         } else {
//             isLong = i % 2 === 0;
//         }
//         chart.renderer.path(['M', x, chart.plotTop + chart.plotHeight + (isLong ? 0 : 28),
//                              'L', x, chart.plotTop + chart.plotHeight + 32, 'Z'])
//             .attr({
//             'stroke': chart.options.chart.plotBorderColor,
//             'stroke-width': 1
//         })
//             .add();
//     }
// };
/**
 * 获取title地区
 */
Meteogram.prototype.getTitle = function () {
    return 'Meteogram for ' + this.xml.location.name + ', ' + this.xml.location.country;
};
/**
 * 生成并返回HighCharts配置参数
 */
Meteogram.prototype.getChartOptions = function () {
    var meteogram = this;
    console.log('数据',this);
    return {
        chart: {
            renderTo: this.container,
            marginBottom: 70,
            marginRight: 40,
            marginTop: 50,
            plotBorderWidth: 1,
            width: 800,
            height: 310
        },
        title: {
            text: this.getTitle(),
            align: 'left'
        },
        credits: {
            text: '根据<a href="https://yr.no">恒天翼</a>预测',
            href: this.xml.credit.link['@attributes'].url,
            position: {
                x: -40
            }
        },
        tooltip: {
            shared: true,
            useHTML: true,
            formatter: function () {
                return meteogram.tooltipFormatter(this);
            }
        },
        xAxis: [{ // 底部 X axis
            type: 'datetime',
            tickInterval: 2 * 36e5, // two hours
            minorTickInterval: 36e5, // one hour
            tickLength: 0,
            gridLineWidth: 1,
            gridLineColor: (Highcharts.theme && Highcharts.theme.background2) || '#F0F0F0',
            startOnTick: false,
            endOnTick: false,
            minPadding: 0,
            maxPadding: 0,
            offset: 30,
            showLastLabel: true,
            labels: {
                format: '{value:%H}'
            }
        }, { // Top X axis
            linkedTo: 0,
            type: 'datetime',
            tickInterval: 24 * 3600 * 1000,
            labels: {
                format: '{value:<span style="font-size: 12px; font-weight: bold">%a</span> %b %e}',
                align: 'left',
                x: 3,
                y: -5
            },
            opposite: true,
            tickLength: 20,
            gridLineWidth: 1
        }],
        yAxis: [{ // 风速 axis
            title: {
                text: null
            },
            labels: {
                format: '{value}',
                style: {
                    fontSize: '10px'
                },
                x: -3
            },
            plotLines: [{ // zero plane
                value: 0,
                color: '#BBBBBB',
                width: 1,
                zIndex: 2
            }],
            // 实现温度刻度
            tickPositioner: function () {
                var max = Math.ceil(this.max) + 1,
                    pos = max - 12, // start
                    ret;
                if (pos < this.min) {
                    ret = [];
                    while (pos <= max) {
                        ret.push(pos += 1);
                    }
                } 
                return ret;
            },
            maxPadding: 0.3,
            tickInterval: 1,
            gridLineColor: (Highcharts.theme && Highcharts.theme.background2) || '#F0F0F0'
        }, { // precipitation axis
            title: {
                text: null
            },
            labels: {
                enabled: false
            },
            gridLineWidth: 0,
            tickLength: 0
        }, 
        // { // 气压标注
        //     allowDecimals: false,
        //     title: { // Title on top of axis
        //         text: 'hPa',
        //         offset: 0,
        //         align: 'high',
        //         rotation: 0,
        //         style: {
        //             fontSize: '16px',
        //             color: Highcharts.getOptions().colors[0]
        //         },
        //         textAlign: 'left',
        //         x: 3
        //     },
        //     labels: {
        //         style: {
        //             fontSize: '8px',
        //             color: Highcharts.getOptions().colors[2]
        //         },
        //         y: 2,
        //         x: 3
        //     },
        //     gridLineWidth: 0,
        //     opposite: true,
        //     showLastLabel: false
        //}
        ],
        legend: {
            enabled: false
        },
        plotOptions: {
            series: {
                pointPlacement: 'between'
            }
        },
        series: [{
            name: '温度',
            data: this.windSpeeds,
            type: 'spline',
            marker: {
                enabled: true,
                states: {
                    hover: {
                        enabled: true
                    }
                }
            },
            tooltip: {
                valueSuffix: '°C'
            },
            zIndex: 1,
            color: '#6495ED',//曲线颜色
            negativeColor: '#48AFE8'
        },
        //  {
        //     name: '降水',
        //     data: this.precipitations,
        //     type: 'column',
        //     color: '#68CFE8',
        //     yAxis: 1,
        //     groupPadding: 0,
        //     pointPadding: 0,
        //     borderWidth: 0,
        //     shadow: false,
        //     dataLabels: {
        //         enabled: true,
        //         formatter: function () {
        //             if (this.y > 0) {
        //                 return this.y;
        //             }
        //         },
        //         style: {
        //             fontSize: '8px'
        //         }
        //     },
        //     tooltip: {
        //         valueSuffix: 'mm'
        //     }
        // }, 
        // {
        //     name: '气压',
        //     color: Highcharts.getOptions().colors[2],
        //     data: this.pressures,
        //     marker: {
        //         enabled: false
        //     },
        //     shadow: false,
        //     tooltip: {
        //         valueSuffix: ' hPa'
        //     },
        //     dashStyle: 'shortdot',
        //     yAxis: 2
        // },
      ]
    }
};
/**
 * 加载highcharts表格
 */
Meteogram.prototype.onChartLoad = function (chart) {
    // this.drawWeatherSymbols(chart);
    this.drawWindArrows(chart);
    console.log(chart);
    // this.drawBlocksForWindArrows(chart);
};
/**
 * 异步创建highcharts
 */
Meteogram.prototype.createChart = function () {
    var meteogram = this;
    this.chart = new Highcharts.Chart(this.getChartOptions(), function (chart) {
        meteogram.onChartLoad(chart);
    });
};
/**
 * 处理数据格式
 */
Meteogram.prototype.parseYrData = function () {
    var meteogram = this,
        xml = this.xml,
        pointStart;
    if (!xml || !xml.forecast) {
        $('#loading').html('<i class="fa fa-frown-o"></i> 加载数据失败，请稍后再试');
        return;
    }
    // 处理XML的事件日期格式
    $.each(xml.forecast.tabular.time, function (i, time) {
        // 事件格式转换
        var from = time['@attributes'].from + ' UTC',
            to = time['@attributes'].to + ' UTC';
        from = from.replace(/-/g, '/').replace('T', ' ');
        from = Date.parse(from);
        to = to.replace(/-/g, '/').replace('T', ' ');
        to = Date.parse(to);
        if (to > pointStart + 4 * 24 * 36e5) {
            return;
        }
        // If it is more than an hour between points, show all symbols
        if (i === 0) {
            meteogram.resolution = to - from;
        }
        // 填充数组
        console.log(time);
        meteogram.symbols.push(time.symbol['@attributes']['var'].match(/[0-9]{2}[dnm]?/)[0]);
        meteogram.symbolNames.push(time.symbol['@attributes'].name);
        //温度
        meteogram.temperatures.push({
            x: from,
            y: parseInt(time.temperature['@attributes'].value),
            // custom options used in the tooltip formatter
            to: to,
            index: i
        });
        //降水
        meteogram.precipitations.push({
            x: from,
            y: parseFloat(time.precipitation['@attributes'].value)
        });
        //风向风速
        meteogram.windDirections.push(parseFloat(time.windDirection['@attributes'].deg));
        meteogram.windDirectionNames.push(time.windDirection['@attributes'].name);
        meteogram.windDirections.push(time.windDirection['@attributes'].deg);
        // meteogram.windSpeeds.push(parseFloat(time.windSpeed['@attributes'].mps));
        meteogram.windSpeeds.push({
            x: from,
            to:to,
            y: parseFloat(time.windSpeed['@attributes'].mps)
        });
        meteogram.windSpeedNames.push(time.windSpeed['@attributes'].name);
        //气压
        meteogram.pressures.push({
            x: from,
            to:to,
            y: parseFloat(time.pressure['@attributes'].value)
        });
        if (i == 0) {
            pointStart = (from + to) / 2;
        }
    });
    // 绘制曲线
    // this.smoothLine(this.temperatures);
    // 获取数据之后加载chart
    this.createChart();
};
// Meteogram方法封装完毕
//获取天气数据
$(function () { 
    if (!location.hash) {
        var place = 'United_Kingdom/England/London';
        //place = 'France/Rhône-Alpes/Val_d\'Isère~2971074';
        //place = 'Norway/Sogn_og_Fjordane/Vik/Målset';
        //place = 'United_States/California/San_Francisco';
        //place = 'United_States/Minnesota/Minneapolis';
        location.hash = 'http://www.yr.no/place/' + place + '/forecast_hour_by_hour.xml';
    }
    $.getJSON(
        'https://www.highcharts.com/samples/data/jsonp.php?url=' + location.hash.substr(1) + '&callback=?',
        function (xml) {
            var meteogram = new Meteogram(xml, 'container');
        }
    );
});
</script>
</body>
</html>